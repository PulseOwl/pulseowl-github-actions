{"version":3,"file":"index.mjs","names":[],"sources":["../src/index.ts"],"sourcesContent":["import * as core from \"@actions/core\";\nimport { existsSync } from \"node:fs\";\nimport { resolve } from \"node:path\";\n\ntype EnvSuffix = \"\" | string;\n\nconst VERSION = \"1.0.0\";\n\nfunction normalizeEnvSuffix(raw: string): EnvSuffix {\n  const v = raw.trim();\n  if (!v) return \"\";\n\n  // Allow only simple suffixes to avoid weird hostname construction.\n  // Examples: staging\", \"qa\", etc.\n  if (!/^[a-z0-9][a-z0-9-]{0,19}$/.test(v)) {\n    throw new Error(\n      `Invalid pulseowl_env \"${raw}\". Allowed: lowercase letters, digits, hyphen (max 20 chars).`\n    );\n  }\n  return v;\n}\n\nfunction integrationsBaseUrl(envSuffix: EnvSuffix): string {\n  // Blank suffix = prod\n  if (!envSuffix) return \"https://integrations.pulseowl.dev\";\n  return `https://integrations-${envSuffix}.pulseowl.dev`;\n}\n\nfunction safeTruncate(s: string, max = 4000): string {\n  if (s.length <= max) return s;\n  return s.slice(0, max) + \"â€¦(truncated)\";\n}\n\nasync function sleep(ms: number) {\n  await new Promise((r) => setTimeout(r, ms));\n}\n\nasync function postJsonWithRetry(\n  url: string,\n  token: string,\n  payload: unknown,\n  maxAttempts = 3\n): Promise<Response> {\n  const body = JSON.stringify(payload);\n  let attempt = 0;\n\n  while (true) {\n    attempt += 1;\n\n    const ac = new AbortController();\n    const timeout = setTimeout(() => ac.abort(), 15_000);\n\n    try {\n      const res = await fetch(url, {\n        method: \"POST\",\n        headers: {\n          \"content-type\": \"application/json\",\n          authorization: `Bearer ${token}`,\n          \"user-agent\": `pulseowl-github-actions-collector/${VERSION}`,\n          \"x-pulseowl-github-actions-collector-version\": VERSION,\n        },\n        body,\n        signal: ac.signal,\n      });\n\n      // Retry on transient statuses\n      if (\n        (res.status === 429 || (res.status >= 500 && res.status <= 599)) &&\n        attempt < maxAttempts\n      ) {\n        const backoffMs = Math.min(2000 * attempt, 8000);\n        core.warning(\n          `PulseOwl API returned ${res.status}. Retrying in ~${backoffMs}ms (attempt ${attempt}/${maxAttempts})`\n        );\n        await sleep(backoffMs);\n        continue;\n      }\n\n      return res;\n    } finally {\n      clearTimeout(timeout);\n    }\n  }\n}\n\nasync function run(): Promise<void> {\n  try {\n    const envInput = core.getInput(\"pulseowl-env\") ?? \"\";\n    const configPathInput = core.getInput(\"config-path\") ?? \"\";\n    const audience =\n      (core.getInput(\"audience\") ?? \"pulseowl\").trim() || \"pulseowl\";\n\n    const envSuffix = normalizeEnvSuffix(envInput);\n    const baseUrl = integrationsBaseUrl(envSuffix);\n    const endpoint = `${baseUrl}/github/v1/collector-data`;\n\n    core.info(`PulseOwl env suffix: \"${envSuffix || \"prod\"}\"`);\n    core.info(`PulseOwl endpoint: ${endpoint}`);\n\n    if (configPathInput.trim()) {\n      const full = resolve(process.cwd(), configPathInput.trim());\n      const exists = existsSync(full);\n      core.info(\n        `config_path: ${configPathInput.trim()} (resolved: ${full}) exists=${exists}`\n      );\n      // For now: do not fail if missing; you said it's optional.\n    } else {\n      core.info(\"config_path: (not provided)\");\n    }\n\n    // Request OIDC token (requires: permissions: id-token: write)\n    // GitHub docs: token is minted by token.actions.githubusercontent.com. :contentReference[oaicite:7]{index=7}\n    const oidc = await core.getIDToken(audience);\n\n    const payload = {\n      kind: \"pulseowl-collector-test\",\n      timestamp: new Date().toISOString(),\n      github: {\n        repository: process.env.GITHUB_REPOSITORY,\n        repository_id: process.env.GITHUB_REPOSITORY_ID,\n        run_id: process.env.GITHUB_RUN_ID,\n        run_attempt: process.env.GITHUB_RUN_ATTEMPT,\n        workflow: process.env.GITHUB_WORKFLOW,\n        ref: process.env.GITHUB_REF,\n        sha: process.env.GITHUB_SHA,\n        actor: process.env.GITHUB_ACTOR,\n      },\n      inputs: {\n        pulseowl_env: envSuffix || \"\",\n        config_path: configPathInput.trim() || \"\",\n      },\n    };\n\n    const res = await postJsonWithRetry(endpoint, oidc, payload, 3);\n    const text = await res.text();\n\n    if (!res.ok) {\n      throw new Error(\n        `PulseOwl API error ${res.status}: ${safeTruncate(text)}`\n      );\n    }\n\n    core.info(\n      `PulseOwl API OK (${res.status}). Response: ${safeTruncate(text)}`\n    );\n  } catch (err) {\n    const msg = err instanceof Error ? err.message : String(err);\n    core.setFailed(msg);\n  }\n}\n\nawait run();\n"],"mappings":"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"}